---
original: 05d5752ad5e1d549b8e18fa667dc881c10c42a5c26cb5089552c2b930fa15c4b
---

NIP-26
=======

委任イベント署名
-----

`ドラフト` `オプション`

この NIP は、イベントを委任して他の鍵ペアで署名できるようにする方法を定義します。

このプロポーザルのもう一つの応用は、クライアントとやり取りする際に「ルート」鍵ペアの使用を抽象化することです。例えば、ユーザーは使用したい各クライアントに対して新しい鍵ペアを生成し、それらの鍵ペアにルート公開鍵に代わってイベントを生成する権限を与えることができます。この場合、ルート鍵ペアはコールドストレージに保管されます。

#### 'delegation' タグの導入

この NIP では、新しいタグ `delegation` を導入します。フォーマットは以下の通りです：

```json
[
  "delegation",
  <委任者の公開鍵>,
  <条件クエリ文字列>,
  <委任トークン: 委任文字列のsha256ハッシュの64バイトのシュノア署名>
]
```

##### 委任トークン

**委任トークン**は、以下の文字列のsha256ハッシュの64バイトのシュノア署名である必要があります：

```
nostr:delegation:<発行者（被委任者）の公開鍵>:<条件クエリ文字列>
```

##### 条件クエリ文字列

上記のクエリ文字列では、以下のフィールドと演算子がサポートされています：

*フィールド*:
1. `kind`
   -  *演算子*:
      -  `=${KIND_NUMBER}` - 被委任者はこの種類のイベントのみ署名可能
2. `created_at`
   -  *演算子*:
      -  `<${TIMESTAMP}` - 被委任者は指定されたタイムスタンプ***より前***に作成されたイベントのみ署名可能
      -  `>${TIMESTAMP}` - 被委任者は指定されたタイムスタンプ***より後***に作成されたイベントのみ署名可能

単一の条件を作成するには、サポートされているフィールドと演算子を使用する必要があります。複数の条件を単一のクエリ文字列で使用することができ、同じフィールドに対しても可能です。条件は `&` で結合する必要があります。

例えば、以下の条件文字列は有効です：

- `kind=1&created_at<1675721813`
- `kind=0&kind=1&created_at>1675721813`
- `kind=1&created_at>1674777689&created_at<1675721813`

大多数のユースケースでは、以下のことが推奨されます：
1. クエリ文字列には、現在の時刻を反映した `created_at` ***より後***の条件を含めるべきです。これにより、被委任者が委任者に代わって過去のノートを公開することを防ぎます。
2. クエリ文字列には、空でない、かつ極端に遠い将来の時間ではない `created_at` ***より前***の条件を含めるべきです。委任に時間的制限がない場合、単にルート鍵を認証に使用するのと同様のセキュリティリスクにさらされます。

#### 例

```
# 委任者:
privkey: ee35e8bb71131c02c1d7e73231daa48e9953d329a4b701f7133c8f46dd21139c
pubkey:  8e0d3d3eb2881ec137a11debe736a9086715a8c8beeeda615780064d68bc25dd

# 被委任者:
privkey: 777e4f60b4aa87937e13acc84f7abcc3c93cc035cb4c1e9f7a9086dd78fffce1
pubkey:  477318cfb5427b9cfc66a9fa376150c1ddbc62115ae27cef72417eb959691396
```

現在のタイムスタンプが `1674834236` であると仮定し、被委任者（477318cf）に今から30日間のノート公開権限を与える委任文字列：
```json
nostr:delegation:477318cfb5427b9cfc66a9fa376150c1ddbc62115ae27cef72417eb959691396:kind=1&created_at>1674834236&created_at<1677426236
```

委任者（8e0d3d3e）は上記の委任文字列のSHA256ハッシュに署名し、その結果が委任トークンとなります：
```
6f44d7fe4f1c09f3954640fb58bd12bae8bb8ff4120853c4693106c82e920e2b898f1f9ba9bd65449a987c39c0423426ab7b53910c0c6abfb41b30bc16e5f524
```

被委任者（477318cf）は、委任者（8e0d3d3e）に代わってイベントを構築できるようになりました。被委任者は自身の秘密鍵でイベントに署名し、公開します。
```json
{
  "id": "e93c6095c3db1c31d15ac771f8fc5fb672f6e52cd25505099f62cd055523224f",
  "pubkey": "477318cfb5427b9cfc66a9fa376150c1ddbc62115ae27cef72417eb959691396",
  "created_at": 1677426298,
  "kind": 1,
  "tags": [
    [
      "delegation",
      "8e0d3d3eb2881ec137a11debe736a9086715a8c8beeeda615780064d68bc25dd",
      "kind=1&created_at>1674834236&created_at<1677426236",
      "6f44d7fe4f1c09f3954640fb58bd12bae8bb8ff4120853c4693106c82e920e2b898f1f9ba9bd65449a987c39c0423426ab7b53910c0c6abfb41b30bc16e5f524"
    ]
  ],
  "content": "Hello, world!",
  "sig": "633db60e2e7082c13a47a6b19d663d45b2a2ebdeaf0b4c35ef83be2738030c54fc7fd56d139652937cdca875ee61b51904a1d0d0588a6acd6168d7be2909d693"
}
```

条件が満たされ（この例では `kind=1`、`created_at>1674834236`、`created_at<1677426236`）、委任トークンの検証時に元の委任文字列の条件から変更されていないことが確認された場合、このイベントは有効な委任とみなされるべきです。

クライアントは、委任されたノートを委任者（8e0d3d3e）が直接公開したかのように表示すべきです。

#### リレーとクライアントのサポート

リレーは `["REQ", "", {"authors": ["A"]}]` のようなリクエストに対して、`pubkey` と委任タグの `[1]` の値の両方をクエリして応答する必要があります。

リレーは、委任者（8e0d3d3e）が被委任者（477318cf）によって公開されたイベントを削除することを許可すべきです（SHOULD）。