---
original: 1f753724e3c574f362498d942757fd376661a8b791689ddccd4b9f5fb1ba7654
---

# NIP-96

## HTTP ファイルストレージ統合

`draft` `optional`

## はじめに

この NIP は、nostr ネットワークと併用することを目的とした HTTP ファイルストレージサーバー用の REST API を定義します。
この API により、nostr ユーザーはファイルをアップロードし、後で nostr ノートで URL を参照できるようになります。

この仕様は、シンプルさを重視し、サーバーが nostr リレーについて学ぶ必要がないように、
ウェブソケットを介した通常の nostr イベントを使用せず、データの保存、要求、取得を行いません。

## サーバーの適応

nostr ユーザーがアクセスできるようにしたいファイルストレージサーバーは、`/.well-known/nostr/nip96.json` に HTTPS ルートを用意し、`api_url` を提供することでオプトインする必要があります：

```js
{
  // 必須
  // ファイルのアップロードと削除はこの URL から提供されます
  // "download_url" フィールドが存在しないか空文字列の場合はダウンロードもここから
  "api_url": "https://your-file-server.example/custom-api-path",
  // オプション
  // 存在しない場合、ダウンロードは api_url から提供されます
  "download_url": "https://a-cdn.example/a-path",
  // オプション
  // 注意：このフィールドは HTTP サーバーが設定するものではありません。
  // nostr リレーが他の HTTP ファイルストレージサーバーの /.well-known/nostr/nip96.json に
  // リダイレクトするために /.well-known/nostr/nip96.json を使用する場合に使用します
  // この場合、"api_url" フィールドは空文字列でなければなりません
  "delegated_to_url": "https://your-file-server.example",
  // オプション
  "supported_nips": [60],
  // オプション
  "tos_url": "https://your-file-server.example/terms-of-service",
  // オプション
  "content_types": ["image/jpeg", "video/webm", "audio/*"],
  // オプション
  "plans": {
    // "free" は唯一の標準化されたプランキーで、
    // クライアントはその存在を使用してサーバーが無料ストレージを提供しているかどうかを知ることができます
    "free": {
      "name": "無料プラン",
      // デフォルトは true
      // すべてのプランは NIP-98 アップロードをサポートする必要がありますが、
      // 一部のプランではそれなしでのアップロードも許可される場合があります
      "is_nip98_required": true,
      "url": "https://...", // プランのランディングページがある場合
      "max_byte_size": 10485760,
      // 日数の範囲 / 0 は期限なし
      // [7, 0] は 7 日から無制限の永続性まで変動する可能性があることを意味します
      // [0, 0] は期限がないことを意味します
      // 早期の期限切れはトラフィックの少なさやその他の要因によるものかもしれません
      "file_expiration": [14, 90],
      "media_transformations": {
        "image": [
          'resizing'
        ]
      }
    }
  }
}
```

### リレーのヒント

注意：このセクションは HTTP サーバー向けではありません。

nostr リレーは、"delegated_to_url" フィールドを含む `/.well-known/nostr/nip96.json` を追加することで、
他の HTTP ファイルストレージサーバーにリダイレクトすることができます。
このフィールドは、サーバーが独自の `/.well-known/nostr/nip96.json` をホストする URL を指します。
この場合、"api_url" フィールドは空文字列でなければならず、他のすべてのフィールドは存在してはいけません。

nostr リレーが HTTP ファイルストレージサーバーも兼ねている場合、
代わりに "api_url" フィールドを使用する必要があります。

### 対応ファイルストレージサーバーのリスト

https://github.com/aljazceru/awesome-nostr#nip-96-file-storage-servers を参照してください。

## 認証

指示がある場合、`クライアント`は [NIP-98](98.md) の `Authorization` ヘッダーを追加する必要があります（**オプションで** エンコードされた `payload` タグをファイルの 256 ビット SHA-256 ハッシュの base64 エンコードに設定します - リクエスト本文全体のハッシュではありません）。

## アップロード

`POST $api_url` を `multipart/form-data` として送信します。

**認証が必要**

フォームフィールドのリスト：

- `file`: **必須** アップロードするファイル
- `caption`: **推奨** 簡単な説明
- `expiration`: UNIX タイムスタンプ（秒）。ファイルを永久に保存する場合は空文字列。サーバーはこれを尊重する必要はありません。
- `size`: ファイルのバイトサイズ。サーバーがファイルサイズの制限を超えている場合に早期に拒否するために使用できる値です。
- `alt`: **推奨** 視覚障害のあるユーザー向けの厳密な説明テキスト。
- `media_type`: "avatar" または "banner"。ファイルがアバターまたはバナーとして使用されることをサーバーに通知します。存在しない場合、サーバーは通常のアップロードとして解釈し、特別な扱いをしません。
- `content_type`: "image/jpeg" などの MIME タイプ。サーバーが MIME タイプをサポートしていない場合に早期に拒否するために使用できる値です。
- `no_transform`: "true" の場合、サーバーにファイルを変換せずにアップロードされたファイルをそのまま提供するよう要求します。拒否される可能性があります。

その他のカスタムフォームデータフィールドは、特定の `サーバー` のサポートに応じて使用される場合があります。
`サーバー` は `クライアント` から送信されたメタデータを保存する必要はありません。

ファイルに埋め込まれた `filename` は `サーバー` によって尊重されない場合があり、内部的には追加のメタデータを無視して SHA-256 ハッシュ値をファイル名として保存する可能性があります。
ハッシュはファイルを一意に識別するのに十分であるため、`ダウンロード` と `削除` のルートで使用されます。

`サーバー` は、ユーザーの `pubkey` 文字列をファイルの所有者としてリンクし、後でファイルを削除できるようにする必要があります。

`no_transform` は、冗長性のためにファイルを複数のサーバーに複製するために使用できます。クライアントは [サーバーリスト](#サーバーの選択) を使用して、同じファイルを含む可能性のある代替サーバーを見つけることができます。ファイルをアップロードし、`no_transform` を要求する場合、クライアントはファイルが変更されたかどうかを検出するために、レスポンスでハッシュが一致することを確認する必要があります。

### レスポンスコード

- `200 OK`: ファイルアップロードは存在しますが、成功しています（既存のハッシュ）
- `201 Created`: ファイルアップロードが成功しました（新しいハッシュ）
- `202 Accepted`: ファイルアップロードは処理待ちです。[遅延処理](#遅延処理) セクションを参照してください
- `413 Payload Too Large`: ファイルサイズが制限を超えています
- `400 Bad Request`: フォームデータが無効またはサポートされていません
- `403 Forbidden`: ユーザーがアップロードを許可されていないか、アップロードされたファイルのハッシュが `Authorization` ヘッダーの `payload` タグに含まれるハッシュと一致しません
- `402 Payment Required`: サーバーによって支払いが必要です。**このフローは未定義です**

アップロードのレスポンスは以下のような JSON オブジェクトです：

```js
{
  // 成功した場合は "success"、そうでない場合は "error"
  status: "success",
  // 自由なテキストの成功、失敗、または情報メッセージ
  message: "アップロードが成功しました。",
  // オプション。「遅延処理」セクションを参照してください
  processing_url: "...",
  // これは NIP-94 イベント形式を使用しますが、"id"、"pubkey"、"created_at"、"sig" などの
  // 一部のフィールドを埋める必要はありません
  //
  // これにはダウンロード URL（"url"）、
  // サーバーの変換前の元のファイルハッシュ（"ox"）、
  // およびオプションで、サーバーが利用可能にしたいすべてのファイルメタデータが含まれます
  //
  // アップロードが失敗した場合、nip94_event フィールドは存在しません
  nip94_event: {
    // 必須タグ: "url" と "ox"
    tags: [
      // /.well-known/nostr/nip96.json の "download_url" フィールド
      // （または "download_url" が存在しないか空の場合は "api_url" フィールド）に
      // 元のファイルハッシュを追加したものと同じ場合があります。
      //
      // `ox` 値に .png ファイル拡張子を追加していることに注意してください
      // （オプションですが、拡張子を追加することを強く推奨します。これにより、nostr クライアントが
      // 正規表現を使用してファイルタイプを検出するのに役立ちます）
      //
      // また、ファイルをダウンロードするための任意の URL でもかまいません
      // （/.well-known/nostr/nip96.json の "download_url" プレフィックスを使用するかどうかにかかわらず）。
      // 例えば、負荷分散の目的などで使用できます。
      ["url", "https://your-file-server.example/custom-api-path/719171db19525d9d08dd69cb716a18158a249b7b3b3ec4bbdec5698dca104b7b.png"],
      // 変換前の元のファイルの SHA-256 ハッシュ。
      // サーバーは、これが元のファイルを表しているにもかかわらず、これを保存する必要があります。
      // なぜなら、ユーザーがこの値を使用して変換されたファイルをダウンロード/削除しようとする可能性があるためです
      ["ox", "719171db19525d9d08dd69cb716a18158a249b7b3b3ec4bbdec5698dca104b7b"],
      // オプション。サーバーの変換後に保存されたファイルの SHA-256 ハッシュ。
      // サーバーはこの値を保存できますが、必須ではありません。
      ["x", "543244319525d9d08dd69cb716a18158a249b7b3b3ec4bbde5435543acb34443"],
      // オプション。クライアントがダウンロード前にファイルタイプを簡単に知るのに役立つため推奨されます。
      ["m", "image/png"]
      // オプション。クライアントがファイルを表示するための適切な UI スペースを確保するのに役立つため推奨されます。
      ["dim", "800x600"]
      // ... その他のオプションの NIP-94 タグ
    ],
    content: ""
  },
  // ... その他のカスタムフィールド（この NIP または NIP-94 タグに追加することを検討してください）
}
```

サーバーが受信したファイルに変換を適用しなかった場合、`nip94_event.tags.*.ox` と `nip94_event.tags.*.x` フィールドの両方が同じ値になることに注意してください。サーバーは、保存されたファイルをサーバーの変換前の**元の**ファイルの SHA-256 ハッシュ（`nip94_event.tags.*.ox` タグの値）にリンクする必要があります。**元の**ファイルの SHA-256 ハッシュは、ダウンロードまたは削除時に保存されたファイルを識別するために使用されます。

`クライアント` は同じファイルを 1 つまたは複数の `サーバー` にアップロードできます。
アップロードが成功した後、`クライアント` はオプションで [NIP-94](94.md) イベントを生成し、不足しているフィールドを含めて任意の nostr `リレー` セットに送信できます。

または、NIP-94 を使用する代わりに、`クライアント` は上記の URL を単に共有したり、nostr ノートに埋め込んだりすることができます。


`クライアント` は `nip94_event` のタグを使用して `imeta` タグを構築することもできます。

### 遅延処理

サーバーが、アップロードされたファイルを遅延ファイル処理のための処理キューに配置したい場合があります。

その場合、サーバーは処理が完了するまで元のファイルを提供し、処理が完了したら元のファイルを処理済みのファイルに置き換える必要があります。アップロードのレスポンスは通常と同じですが、`nip94_event.tags.*.x` や `nip94_event.tags.*.size` などの一部のオプションのメタデータは利用できません。

事前に分かっている予想される結果のメタデータは、レスポンスで返す必要があります。
例えば、ファイル処理によってファイルが "jpg" から "webp" に変更される場合、
`nip94_event.tags.*.url` フィールドの値に ".webp" 拡張子を使用し、`nip94_event.tags.*.m` フィールドに "image/webp" を設定します。
処理が終わるまで不明なメタデータがある場合は、レスポンスから省略してください。

アップロードのレスポンスには、クライアントがファイル処理の完了を確認するために使用できる一時的な URL を通知する `processing_url` フィールドが含まれる場合があります。

処理が完了していない場合、サーバーは `processing_url` URL で **200 OK** と以下の JSON で応答する必要があります：

```
{
  // "processing" である必要があります。"error" の場合、処理が失敗したことを意味します。
  status: "processing",
  message: "処理中です。更新されたステータスを後でもう一度確認してください。",
  percentage: 15 // 処理の進捗率。0から100までの整数。
}
```

処理が完了すると、サーバーは `processing_url` URL で **201 Created** ステータスと、前述の通常の成功 JSON レスポンス（今回は `processing_url` フィールドなし）で応答し、処理前には利用できなかった `nip94_event.tags.*` フィールドのオプションのメタデータを含む可能性があります。

### ファイル圧縮

サーバーによってファイル圧縮やメタデータの削除などの変換が適用される場合があります。
ただし、ダウンロードや削除などのすべてのファイル操作において、URL 文字列内でファイルを識別するのは**元の**ファイルの SHA-256 ハッシュです。

## ダウンロード

`GET $api_url/<sha256-hash>(.ext)`

アップロードのレスポンスフィールド `nip94_event.tags.*.url` で通知されるプライマリファイルダウンロード URL は、
上記のようなものである場合もあれば、そうでない場合（サーバーが望む任意の非標準 URL）もあります。
そうでない場合でも、サーバーは前段落で言及した標準 URL でのダウンロードにも応答する必要があります。
これにより、クライアントが SHA-256 ファイルハッシュだけを知っていて、任意の NIP-96 互換サーバーでファイルのダウンロードを試みることが可能になります。

"\<sha256-hash\>" の部分は、アップロードされたファイルがサーバーの変換を経た場合でも、**変換された**ファイルではなく**元の**ファイルのものであることに注意してください。

".ext"（つまり「ファイル拡張子」）のサポートは `サーバー` に必須です。`クライアント` がパスに追加することはオプションですが、推奨されます。
存在する場合、`サーバー` が送信する `Content-Type` ヘッダーを知るために使用される場合があります（例：".png" 拡張子の場合 "Content-Type": "image/png"）。
ファイル拡張子は、ハッシュがファイルを一意に識別するために必要な唯一の文字列であるため、存在しない場合があります。

例：`$api_url/719171db19525d9d08dd69cb716a18158a249b7b3b3ec4bbdec5698dca104b7b.png`

### メディア変換

`サーバー` は、一部のメディア変換クエリパラメータに応答し、サポートしていないものは無視して
元のメディアファイルを変換なしで提供する場合があります。

#### 画像変換

##### リサイズ

アップロード時に、`サーバー` は元のアスペクト比を尊重してリサイズされた画像バリアント（サムネイルなど）を作成する場合があります。
`クライアント` は `w` クエリパラメータを使用して、希望のピクセル幅の画像バージョンをリクエストできます。
`サーバー` は、パラメータ値に最も近い幅のバリアントを提供するか、
その場で生成された画像バリアントを提供できます。

例：`$api_url/<sha256-hash>.png?w=32`

## 削除

`DELETE $api_url/<sha256-hash>(.ext)`

**認証が必要**

`/<sha256-hash>` の部分は、アップロードされたファイルがサーバーの変換を経た場合でも、**変換された**ファイルではなく**元の**ファイルのものであることに注意してください。

拡張子はオプションです。ファイルハッシュがファイルを識別するために必要な唯一の情報だからです。

`サーバー` は、元のアップローダー以外のユーザーからの削除を適切な HTTP レスポンスコード（403 Forbidden）で拒否する必要があります。

同じファイル（同じハッシュを持つ）を複数のユーザーがアップロードしている可能性があることに注意してください。この場合、削除はファイルを実際に削除するのではなく、ファイル所有者リストからユーザーの `pubkey` を削除するだけです（サーバーが同じファイルのコピーを1つだけ保持していると仮定します。同じファイルの複数回のアップロードは同じファイルハッシュになるためです）。

成功したレスポンスは 200 OK で、基本的な JSON フィールドのみを含みます：

```
{
  status: "success",
  message: "ファイルが削除されました。"
}
```

## ファイルの一覧表示

`GET $api_url?page=x&count=y`

**認証が必要**

認証されたユーザーの pubkey にリンクされたファイルのリストを返します。

レスポンス例：

```js
{
  "count": 1, // サーバーのページサイズ、例：max(1, min(server_max_page_size, arg_count))
  "total": 1, // ファイルの総数
  "page": 0, // 現在のページ番号
  "files": [
    {
      "tags": [
        ["ox": "719171db19525d9d08dd69cb716a18158a249b7b3b3ec4bbdec5698dca104b7b"],
        ["x": "5d2899290e0e69bcd809949ee516a4a1597205390878f780c098707a7f18e3df"],
        ["size", "123456"],
        ["alt", "笑わせるミーム"],
        ["expiration",  "1715691139"],
        // ...その他のメタデータ
      ]
      "content": "ハハ、面白いミーム", // キャプション
      "created_at": 1715691130 // アップロードのタイムスタンプ
    },
    ...
  ]
}
```

`files` には NIP-94 イベントの配列が含まれています

### クエリ引数

- `page` ページ番号（`offset=page*count`）
- `count` ページあたりのアイテム数

## サーバーの選択

注意：HTTP ファイルストレージサーバー開発者はこのセクションをスキップしてください。これはクライアント開発者向けです。

ファイルサーバー設定イベントは、ユーザーがファイルをアップロードしたいサーバーを1つ以上選択するための種類 10096 の置換可能イベントです。サーバーは `server` タグとしてリストされます：

```js
{
  // ...
  "kind": 10096,
  "content": "",
  "tags": [
    ["server", "https://file.server.one"],
    ["server", "https://file.server.two"]
  ]
}
```