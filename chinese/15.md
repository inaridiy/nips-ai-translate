---
original: d3bf7365a532508ea955140ef788b65624512b6cabc8b92961cfd78c7c1255c5
---

NIP-15
======

Nostr 市场
-----------------

`草案` `可选`

基于 [Diagon-Alley](https://github.com/lnbits/Diagon-Alley)。

在 [NostrMarket](https://github.com/lnbits/nostrmarket) 和 [Plebeian Market](https://github.com/PlebeianTech/plebeian-market) 中实现。

## 术语

- `merchant`（商家） - 拥有 NOSTR 密钥对的产品卖家
- `customer`（客户） - 拥有 NOSTR 密钥对的产品买家
- `product`（产品） - 商家出售的商品
- `stall`（摊位） - 由商家控制的产品列表（一个商家可以拥有多个摊位）
- `marketplace`（市场） - 用于搜索摊位和购买产品的客户端软件

## Nostr 市场客户端

### 商家管理

商家在此创建、更新和删除摊位和产品，并管理销售、支付和与客户的沟通。

商家管理软件可以完全是客户端的，但为了方便和保持在线，实现可能会有一个服务器客户端监听 NOSTR 事件。

### 市场

市场软件应该完全是客户端的，可以是独立的应用程序，也可以是纯前端网页。客户订阅不同商家的 NOSTR 公钥，这些商家的摊位和产品就会被列出并可搜索。市场客户端类似于任何其他电子商务网站，具有购物篮和结账功能。市场可能还希望包括一个客户支持区域，用于与商家直接通信。

## 商家发布/更新产品（事件）

商家可以发布以下事件：
| Kind      |                    | 描述                                                                                                     |
| --------- | ------------------ | --------------------------------------------------------------------------------------------------------------- |
| `0`       | `set_meta`         | 商家描述（类似于任何 `nostr` 公钥）。                                                                 |
| `30017`   | `set_stall`        | 创建或更新摊位。                                                                                       |
| `30018`   | `set_product`      | 创建或更新产品。                                                                                     |
| `4`       | `direct_message`   | 与客户沟通。消息可以是纯文本或 JSON。                                          |
| `5`       | `delete`           | 删除产品或摊位。                                                                                    |

### 事件 `30017`：创建或更新摊位

**事件内容**

```json
{
  "id": <字符串，由商家生成的 ID。不建议使用连续的 ID（`0`、`1`、`2`...）>,
  "name": <字符串，摊位名称>,
  "description": <字符串（可选），摊位描述>,
  "currency": <字符串，使用的货币>,
  "shipping": [
    {
      "id": <字符串，由商家生成的运输区域 ID>,
      "name": <字符串（可选），区域名称>,
      "cost": <浮点数，基本运输成本。货币在摊位级别定义>,
      "regions": [<字符串，包含在此区域内的地区>]
    }
  ]
}
```

不是自解释的字段：
 - `shipping`：
   - 一个包含此摊位可能的运输区域的数组。
   - 客户必须选择其中一个运输区域。
   - 不同区域的运输可能有不同的成本。对于某些商品（例如数字商品），成本可能为零。
   - `id` 是商家使用的内部值。此值必须作为客户选择发送回。
   - 每个运输区域包含该运输区域订单的基本成本，但如果某个产品的运输成本高于基本成本，也可以为该产品指定特定的运输成本。

**事件标签**

```json
{
  "tags": [["d", <字符串，摊位 ID]],
  ...
}
```
 - `d` 标签是必需的，其值必须与摊位 `id` 相同。

### 事件 `30018`：创建或更新产品

**事件内容**

```json
{
  "id": <字符串，由商家生成的 ID（不建议使用连续 ID）>,
  "stall_id": <字符串，此产品所属摊位的 ID>,
  "name": <字符串，产品名称>,
  "description": <字符串（可选），产品描述>,
  "images": <[字符串]，图片 URL 数组，可选>,
  "currency": <字符串，使用的货币>,
  "price": <浮点数，产品成本>,
  "quantity": <整数或 null，可用数量>,
  "specs": [
    [<字符串，规格键>, <字符串，规格值>]
  ],
  "shipping": [
    {
      "id": <字符串，运输区域的 ID（必须与摊位中定义的区域之一匹配）>,
      "cost": <浮点数，额外运输成本。货币在摊位级别定义>
    }
  ]
}
```

不是自解释的字段：
 - `quantity` 对于无限供应的商品（如数字商品或服务）可以为 null
 - `specs`：
   - 可选的键值对数组。它允许客户 UI 以结构化方式呈现产品规格。它还允许比较产品
   - 例如：`[["operating_system", "Android 12.0"], ["screen_size", "6.4 inches"], ["connector_type", "USB Type C"]]`

    _待定_：是否将 `spec` 移至事件的 `tags` 部分？

- `shipping`：
   - 一个可选的数组，用于需要特殊运输成本的产品，这些成本将添加到摊位中定义的基本运输成本上
   - `id` 应与摊位的 `shipping` 字段中定义的运输区域 id 匹配
   - 要计算订单的总运输成本，用户将在结账时选择一个运输选项，然后客户端必须考虑以下成本：
     - 所选运输选项的摊位基本成本
     - 产品单位乘以产品中指定的运输成本（如果有）的结果。

**事件标签**

```json
  "tags": [
    ["d", <字符串，产品 ID],
    ["t", <字符串（可选），产品类别],
    ["t", <字符串（可选），产品类别],
    ...
  ],
  ...
```

 - `d` 标签是必需的，其值必须与产品 `id` 相同。
 - `t` 标签是可搜索标签，它代表产品可能属于的不同类别（`food`、`fruits`）。可以存在多个 `t` 标签。

## 结账事件

所有结账事件都使用 [NIP-04](04.md) 作为 JSON 字符串发送。

商家和客户可以交换代表不同操作的 JSON 消息。每个 `JSON` 消息必须有一个 `type` 字段，指示 JSON 代表什么。可能的类型：

| 消息类型 | 发送者  | 描述         |
|--------------|----------|---------------------|
| 0            | 客户 | 新订单           |
| 1            | 商家 | 支付请求     |
| 2            | 商家 | 订单状态更新 |

### 步骤 1：客户订单（事件）
以下 JSON 放在 [NIP-04](04.md) 的内容中。

```json
{
  "id": <字符串，由客户生成的 ID>,
  "type": 0,
  "name": <字符串（可选），???>,
  "address": <字符串（可选），对于实物商品应提供地址>,
  "message": "<字符串（可选），给商家的消息>,
  "contact": {
    "nostr": <32 字节十六进制公钥>,
    "phone": <字符串（可选），如果客户希望通过电话联系>,
    "email": <字符串（可选），如果客户希望通过电子邮件联系>
  },
  "items": [
    {
      "product_id": <字符串，产品 ID>,
      "quantity": <整数，客户订购的产品数量>
    }
  ],
  "shipping_id": <字符串，运输区域 ID>
}

```

_待定_：`contact.nostr` 是否必需？


### 步骤 2：商家请求支付（事件）

由商家发回以请求支付。商家可以检查的任何支付选项都是有效的。

以下 JSON 放在 [NIP-04](04.md) 的 `content` 中。

`payment_options`/`type` 包括：

- `url` 支付页面的 URL，如 Stripe、PayPal、BTCPay Server 等
- `btc` 比特币链上地址
- `ln` 比特币闪电网络发票
- `lnurl` 比特币 lnurl-pay

```json
{
  "id": <字符串，订单 ID>,
  "type": 1,
  "message": <字符串，给客户的消息，可选>,
  "payment_options": [
    {
      "type": <字符串，选项类型>,
      "link": <字符串，URL、比特币地址、闪电网络发票等>
    },
    {
      "type": <字符串，选项类型>,
      "link": <字符串，URL、比特币地址、闪电网络发票等>
    },
    {
      "type": <字符串，选项类型>,
      "link": <字符串，URL、比特币地址、闪电网络发票等>
    }
  ]
}
```

### 步骤 3：商家验证支付/发货（事件）

一旦收到并处理了付款。

以下 JSON 放在 [NIP-04](04.md) 的 `content` 中。

```json
{
  "id": <字符串，订单 ID>,
  "type": 2,
  "message": <字符串，给客户的消息>,
  "paid": <布尔值：是否已收到付款>,
  "shipped": <布尔值：是否已发货>,
}
```

## 自定义市场

使用 [NIP-19](19.md#shareable-identifiers-with-extra-metadata) 中的 `naddr` 创建自定义用户体验。使用 `naddr` 可以轻松共享市场事件，同时包含丰富的元数据集。这些元数据可以包括中继、商家资料等。随后，它允许将商家分组到一个市场中，使市场创建者能够配置市场的用户界面和用户体验，并共享该市场。这种自定义可以包括市场名称、描述、标志、横幅、主题，甚至颜色方案等元素，提供量身定制的独特市场体验。

### 事件 `30019`：创建或更新市场 UI/UX

**事件内容**

```json
{
  "name": <字符串（可选），市场名称>,
  "about": <字符串（可选），市场描述>,
  "ui": {
    "picture": <字符串（可选），市场标志图片 URL>,
    "banner": <字符串（可选），市场标志横幅 URL>,
    "theme": <字符串（可选），市场主题>,
    "darkMode": <布尔值，true/false>
  },
  "merchants": [公钥数组（可选）],
  ...
}
```

此事件利用 naddr 实现全面的市场配置自定义和共享，营造独特而吸引人的市场环境。

## 拍卖

### 事件 `30020`：创建或更新作为拍卖出售的产品

**事件内容**：
```json
{
    "id": <字符串，由商家生成的 UUID。不建议使用连续的 ID（`0`、`1`、`2`...）>,
    "stall_id": <字符串，此产品所属摊位的 UUID>,
    "name": <字符串，产品名称>,
    "description": <字符串（可选），产品描述>,
    "images": <[字符串]，图片 URL 数组，可选>,
    "starting_bid": <整数>,
    "start_date": <整数（可选）UNIX 时间戳，拍卖开始/将开始的日期>,
    "duration": <整数，拍卖持续的秒数，不包括可能发生的时间延长>,
    "specs": [
        [<字符串，规格键>, <字符串，规格值>]
    ],
    "shipping": [
        {
            "id": <字符串，运输区域的 UUID。必须与摊位中定义的区域之一匹配>,
            "cost": <浮点数，额外运输成本。货币在摊位级别定义>
        }
    ]
}
```

> [!注意]
> 作为拍卖出售的商品在结构上与固定价格商品非常相似，但有一些值得注意的重要区别。

* 如果拍卖计划在特定日期开始，`start_date` 可以设置为未来的日期，如果开始日期未知/隐藏，则可以省略。如果未指定开始日期，稍后需要编辑拍卖以设置实际日期。

* 拍卖在 `start_date` 之后运行初
始秒数，由 `duration` 指定。

### 事件 `1021`：出价

```json
{
    "content": <整数，出价金额（以 sat 为单位）>,
    "tags": [["e", <要出价的拍卖的事件 ID>]],
}
```

出价只是 kind `1021` 的事件，其 `content` 字段指定金额，以拍卖的货币为单位。出价必须引用一个拍卖。

> [!注意]
> 作者可以根据需要多次编辑拍卖（它们是"参数化可替换事件"）- 即使在 start_date 之后，但在收到第一个出价后就不能再编辑！这是通过出价引用拍卖的事件 ID（而不是产品 UUID）来强制执行的，每个新版本的拍卖产品都会改变事件 ID。因此，出价总是附加到一个"版本"。在出价后编辑拍卖会导致新产品失去出价！

### 事件 `1022`：出价确认

**事件内容**：

```json
{
    "status": <字符串，"accepted" | "rejected" | "pending" | "winner">,
    "message": <字符串（可选）>,
    "duration_extended": <整数（可选），延长的秒数>
}
```

**事件标签**：
```json
  "tags": [["e" <被确认的出价的事件 ID>], ["e", <拍卖的事件 ID>]],
```

在被其他客户端视为有效之前，出价应该由商家确认。因此，客户端应该订阅它们关注的每个拍卖的*出价确认*事件（kind `1022`），除了实际出价之外，还应检查出价确认的 pubkey 是否与商家的 pubkey 匹配（除了检查签名）。

`content` 字段是一个 JSON，至少包含一个 `status`。`winner` 是在拍卖结束后商家选择中标出价时对*中标出价*的回复方式。

出价被标记为 `rejected` 或 `pending` 的原因取决于商家的实现和配置 - 可能是从基本验证错误（金额太低）到出价人被列入黑名单或出价人缺乏足够的*信任*，这可能导致出价被标记为 `pending`，直到进行足够的验证。两者的区别在于 `pending` 出价*可能*在出价人采取额外步骤后获得批准，而 `rejected` 出价不能在以后获得批准。

`content` JSON 中可能会出现一个额外的 `message` 字段，以提供关于出价被 `rejected` 或 `pending` 的进一步上下文。

另一种可能发生的情况是 - 如果出价发生在拍卖结束日期附近 - 商家可能决定将拍卖持续时间再延长几分钟。这是通过在出价确认中传递 `duration_extended` 字段来完成的，该字段包含初始持续时间延长的秒数。因此，拍卖的实际结束日期始终是 `start_date + duration + (所有确认中 c.duration_extended 的总和)`。

## 客户支持事件

客户支持通过指定的任何通信方式处理。如果通过 nostr 通信，则使用 [NIP-04](04.md)。

## 附加信息

标准数据模型可以在<a href="https://raw.githubusercontent.com/lnbits/nostrmarket/main/models.py">这里</a>找到