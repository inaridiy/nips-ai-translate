---
original: 55d267aae20c80081cc4eac6d868c7714e5543b684a7ae8e2d1acdb34aa60ea4
---

NIP-90
======

データ自動販売機（Data Vending Machine）
--------------------

`ドラフト` `オプション`

この NIP は、オンデマンド計算を実行するための顧客とサービスプロバイダー間のインタラクションを定義します。

お金を入れて、データを出す。

## 種類
この NIP は、データ自動販売機の使用のために `5000-7000` の範囲を予約します。

| 種類      | 説明               |
| ----      | -----------       |
| 5000-5999 | ジョブリクエストの種類 |
| 6000-6999 | ジョブ結果          |
| 7000      | ジョブフィードバック  |

ジョブ結果は常に、ジョブリクエストの種類よりも `1000` 高い種類番号を使用します（例：リクエスト：`kind:5001` は結果：`kind:6001` を得ます）。

ジョブリクエストの種類は[別途定義](https://github.com/nostr-protocol/data-vending-machines/tree/master/kinds)されています。

## 根拠
Nostr はデータ処理のマーケットプレイスとして機能し、ユーザーは特定の方法（例：「音声からテキスト」、「要約」など）でジョブを処理するよう要求しますが、必ずしも「誰が」データを処理するかは気にしません。

この NIP は1対1のマーケットプレイスと混同されるべきではありません。代わりに、ユーザーが望む出力と支払い意思を発表し、サービスプロバイダーが可能な限り最良の方法でジョブ要件を満たすために競争するフローを説明します。

### アクター
この NIP で説明されるワークフローには2つのアクターがあります：
* 顧客（ジョブを要求するnpub）
* サービスプロバイダー（ジョブを実行するnpub）

## ジョブリクエスト（`kind:5000-5999`）
顧客によって公開されるデータ処理のリクエスト。このイベントは、顧客が何らかの計算結果を受け取ることに興味があることを示します。

```json
{
    "kind": 5xxx, // 5000-5999の範囲内の種類
    "content": "",
    "tags": [
        [ "i", "<data>", "<input-type>", "<relay>", "<marker>" ],
        [ "output", "<mime-type>" ],
        [ "relays", "wss://..." ],
        [ "bid", "<msat-amount>" ],
        [ "t", "bitcoin" ]
    ]
}
```

すべてのタグはオプションです。

* `i` タグ：ジョブの入力データ（0個以上の入力）
    * `<data>`：入力の引数
    * `<input-type>`：この引数の解釈方法。以下のいずれかでなければなりません：
        * `url`：処理されるべきデータのURLをフェッチする。
        * `event`：Nostrイベントのid。
        * `job`：指定されたイベントIDを持つ以前のジョブの出力。どの出力を基にするかの決定はサービスプロバイダーに委ねられます（例：顧客からのシグナリングを待つ、支払いを待つなど）。
        * `text`：`<data>` が入力の値であり、解決は必要ありません。
    * `<relay>`：`event` または `job` の入力タイプの場合、イベント/ジョブが公開されたリレー。それ以外の場合はオプションまたは空の文字列。
    * `<marker>`：ジョブのコンテキスト内でこの入力をどのように使用するかを示すオプションのフィールド。
* `output`：期待される出力形式。異なるジョブリクエスト `kind` がこれをより正確に定義します。
* `param`：ジョブのオプションパラメータ。キー（最初の引数）/値（2番目の引数）として。異なるジョブリクエスト `kind` がこれをより正確に定義します（例：`[ "param", "lang", "es" ]`）。
* `bid`：顧客は支払う意思のある最大金額（ミリサット単位）を指定できます。
* `relays`：サービスプロバイダーが応答を公開すべきリレーのリスト。
* `p`：顧客が興味を持っているサービスプロバイダー。他のSPもジョブの処理を選択する可能性があります。

## 暗号化されたパラメータ

ユーザーが入力パラメータを秘密にしたい場合、`i` と `param` タグをサービスプロバイダーの 'p' タグで暗号化し、コンテンツフィールドに追加できます。タグに `encrypted` を追加します。プライベートタグの暗号化には、[NIP-04 - 暗号化ダイレクトメッセージ暗号化](https://github.com/nostr-protocol/nips/blob/master/04.md)を使用し、共有秘密鍵にはユーザーの秘密鍵とサービスプロバイダーの公開鍵を使用します。

```json
[
  ["i", "フランスの首都は何ですか？", "text"],
  ["param", "model", "LLaMA-2"],
  ["param", "max_tokens", "512"],
  ["param", "temperature", "0.5"],
  ["param", "top-k", "50"],
  ["param", "top-p", "0.7"],
  ["param", "frequency_penalty", "1"]
]

```

このパラメータデータは暗号化され、`content` フィールドに追加され、`p` タグが存在する必要があります。

```json
{
  "content": "BE2Y4xvS6HIY7TozIgbEl3sAHkdZoXyLRRkZv4fLPh3R7LtviLKAJM5qpkC7D6VtMbgIt4iNcMpLtpo...",
  "tags": [
    ["p", "04f74530a6ede6b24731b976b8e78fb449ea61f40ff10e3d869a3030c4edc91f"],
    ["encrypted"]
  ],
  ...
}
```


## ジョブ結果（`kind:6000-6999`）

サービスプロバイダーはジョブ結果を公開し、ジョブ結果の出力を提供します。元のジョブリクエストイベントIDと顧客のpubkeyをタグ付けする必要があります。

```json
{
  "pubkey": "<サービスプロバイダーのpubkey>",
  "content": "<ペイロード>",
  "kind": 6xxx,
  "tags": [
    ["request", "<ジョブリクエスト>"],
    ["e", "<ジョブリクエストID>", "<リレーヒント>"],
    ["i", "<入力データ>"],
    ["p", "<顧客のpubkey>"],
    ["amount", "要求された支払い金額", "<オプションのbolt11>"]
  ],
  ...
}
```

* `request`：ジョブリクエストイベントのJSON文字列化。
* `amount`：サービスプロバイダーが支払いを要求しているミリサット。オプションの3番目の値はbolt11インボイスです。
* `i`：リクエストで指定された元の入力。

## 暗号化された出力

リクエストに暗号化されたパラメータがある場合、出力は暗号化され、`content` フィールドに配置されます。出力が暗号化されている場合、入力データを平文で含む `i` タグは避けてください。
出力コンテンツが `encrypted` であることを示すために、encrypted タグを追加します。

```json
{
  "pubkey": "<サービスプロバイダーのpubkey>",
  "content": "<暗号化されたペイロード>",
  "kind": 6xxx,
  "tags": [
    ["request", "<ジョブリクエスト>"],
    ["e", "<ジョブリクエストID>", "<リレーヒント>"],
    ["p", "<顧客のpubkey>"],
    ["amount", "要求された支払い金額", "<オプションのbolt11>"],
    ["encrypted"]
  ],
  ...
}
```

## ジョブフィードバック

サービスプロバイダーは顧客にジョブに関するフィードバックを提供できます。

```json
{
  "kind": 7000,
  "content": "<空またはペイロード>",
  "tags": [
    ["status", "<ステータス>", "<追加情報>"],
    ["amount", "要求された支払い金額", "<bolt11>"],
    ["e", "<ジョブリクエストID>", "<リレーヒント>"],
    ["p", "<顧客のpubkey>"],
  ],
  ...
}
```

* `content`：空またはジョブ結果（例：部分結果サンプル用）
* `amount` タグ：[ジョブ結果](#ジョブ結果-kind6000-6999)セクションで定義されています。
* `status` タグ：サービスプロバイダーはこのフィードバックステータスが何を指すかを示す必要があります。[ジョブフィードバックステータス](#ジョブフィードバックステータス)がステータスを定義します。追加の人間が読める情報を追加の引数として追加できます。

* 注：入力パラメータが入力の暗号化を必要とする場合、`content` フィールドには `p` タグをキーとして暗号化されたペイロードが含まれます。

### ジョブフィードバックステータス

| ステータス         | 説明                                                                                                 |
| --------           | -------------                                                                                               |
| `payment-required` | サービスプロバイダーが続行する前に支払いを要求しています。                                                        |
| `processing`       | サービスプロバイダーがジョブを処理しています。                                                                     |
| `error`            | サービスプロバイダーがジョブを処理できませんでした。                                                             |
| `success`          | サービスプロバイダーがジョブを正常に処理しました。                                                            |
| `partial`          | サービスプロバイダーがジョブを部分的に処理しました。`.content` には部分結果のサンプルが含まれる場合があります。 |

任意のジョブフィードバックイベントには、[ジョブ結果](#ジョブ結果-kind6000-6999)セクションで説明されているように、`.content` フィールドに結果が含まれる場合があります。これは、サービスプロバイダーがこれまでに処理された結果のサンプルを提供するのに役立ちます。


# プロトコルフロー

* 顧客がジョブリクエストを公開します（例：`kind:5000` 音声からテキスト）。
* サービスプロバイダーは `kind:7000` ジョブフィードバックイベントを送信する場合があります（例：`payment-required`、`processing`、`error` など）。
* 完了時、サービスプロバイダーは `kind:6000` ジョブ結果イベントでジョブの結果を公開します。
* サービスプロバイダーの指示に従って支払うべき `amount` がある場合、ユーザーはいつでも含まれる `bolt11` を支払うか、サービスプロバイダーがユーザーに送信したジョブ結果イベントにzapを送ることができます。

ジョブフィードバック（`kind:7000`）とジョブ結果（`kind:6000-6999`）イベントには `amount` タグが含まれる場合があり、これは支払いの提案として解釈できます。サービスプロバイダーは、支払いが必要であり、支払いが送信されるまでそれ以上のアクションが実行されないことを示すために、`payment-required` フィードバックイベントを使用する必要があります。

顧客は常に、含まれる `bolt11` インボイスを支払うか、支払いを要求するイベントにzapを送ることができ、サービスプロバイダーはbolt11インボイスを含めることを選択した場合、両方を監視する必要があります。

## プロトコルフローに関する注意事項
このフローは意図的に曖昧にされており、顧客とサービスプロバイダー間のインタラクションに大きな柔軟性を持たせています。これにより、サービスプロバイダーは自身の決定やリスク認識に基づいて行動をモデル化できます。

一部のサービスプロバイダーは、`processing` を送信する前や結果を配信する前に、最初の反応として `payment-required` を送信することを選択する場合があります。また、ジョブの部分的な結果（例：サンプル）を提供し、残りの結果を配信するために `payment-required` を送信する場合もあります。さらに、一部のサービスプロバイダーは、npubの過去の行動に基づいて支払いの可能性を評価し、最高のUXを提供するために支払いを要求する前にジョブ結果を提供することを選択する場合もあります。

個々の自動販売機がどのようにビジネスを運営するかを定義すること
はこのNIPの役割ではありません。

# キャンセル
ジョブリクエストは、ジョブリクエストイベントをタグ付けした `kind:5` 削除リクエストイベントを公開することでキャンセルできます。

# 付録1：ジョブチェーニング
顧客は、あるジョブの出力が別のジョブの入力となるように、複数のジョブを連鎖的に処理するよう要求することができます（例：ポッドキャストの文字起こし → 文字起こしの要約）。これは、`job` タイプで異なるジョブのイベントIDを入力として指定することで行われます。

サービスプロバイダーは、前のジョブの結果を見た瞬間に後続のジョブの処理を開始することができますが、通常はまずzapが公開されるのを待つでしょう。これにより、ジョブ#1のサービスプロバイダーが有利になるためにzapイベントの公開を遅らせるリスクが生じます。このリスクをどう軽減するか、あるいはジョブ#1のサービスプロバイダーの結果が十分に良いと判断して明示的なzapを待たずに処理を進めるかは、サービスプロバイダーが決定することです。

これにより、サービスプロバイダーにより高度な柔軟性が与えられます（洗練されたサービスプロバイダーはいずれにせよこの柔軟性を活用するでしょう）。

# 付録2：サービスプロバイダーの発見可能性
サービスプロバイダーは、NIP-89アナウンスメントを使用してジョブの種類のサポートを広告することができます：

```js
{
  "kind": 31990,
  "pubkey": "<pubkey>",
  "content": "{
    \"name\": \"翻訳DVM\",
    \"about\": \"ビットコインコンテンツの翻訳を専門とするDVMです。\"
  }",
  "tags": [
    ["k", "5005"], // 例：翻訳
    ["t", "bitcoin"] // 例：オプションでビットコインの音声文字起こしを専門とし、「Drivechains」を「Ridechains」と混同しないことを広告
  ],
  ...
}
```

顧客は、NIP-89を使用して、フォローしているユーザーがどのサービスプロバイダーを使用しているかを確認できます。