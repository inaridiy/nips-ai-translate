---
original: a98a8883f5d465d76f38c5105c74cb4342edcd4d3e35b3eeb581fcaa0754c0af
---

NIP-47
======

Nostr ウォレット接続
--------------------

`ドラフト` `オプション`

## 根拠

この NIP は、クライアントが標準化されたプロトコルを通じてリモートの Lightning ウォレットにアクセスする方法を説明しています。カストディアンがこれを実装するか、ユーザーがウォレット/ノードと Nostr ウォレット接続プロトコルをブリッジするブリッジを実行する可能性があります。

## 用語

* **クライアント**: Lightning インボイスを支払いたい任意のプラットフォーム上の Nostr アプリ。
* **ユーザー**: **クライアント**を使用し、自分のウォレットアプリを**クライアント**に接続したい人。
* **ウォレットサービス**: 通常、常時稼働しているコンピューター（例：クラウドや Raspberry Pi 上）で実行される Nostr アプリ。このアプリは、提供するウォレットの API にアクセスできます。

## 動作理論
 1. この NIP を使用して他の nostr ユーザーに lightning 支払いを送信したい**ユーザー**は、まず NIP-47 準拠のウォレットアプリケーションから特別な「接続」URI を取得する必要があります。ウォレットアプリケーションは、QR コード画面や貼り付け可能な文字列、またはその他の手段でこの URI を提供する場合があります。
 
 2. **ユーザー**は、この URI を貼り付けたり QR コードをスキャンしたりして、**クライアント**にコピーする必要があります。**クライアント**はこの URI を保存し、後で**ユーザー**が支払いを行う際に使用します。**クライアント**は、URI で指定されたリレーから `info` (13194) イベントをリクエストする必要があります。**ウォレットサービス**は以前にそのイベントをそれらのリレーに送信しており、リレーは置換可能なイベントとしてそれを保持します。
 
 3. **ユーザー**が支払いを開始すると、nostr **クライアント**は `pay_invoice` リクエストを作成し、URI からのトークンを使用して暗号化し、接続 URI で指定されたリレーに送信します（種類 23194）。**ウォレットサービス**はそれらのリレーでリッスンしており、リクエストを復号化し、**ユーザーの**ウォレットアプリケーションに連絡して支払いを送信します。**ウォレットサービス**は、接続 URI がウォレットアプリ API にアクセスできるリレーを指定しているため、ウォレットアプリケーションとの通信方法を知っています。
 
 4. 支払いが完了すると、**ウォレットサービス**は暗号化された `response`（種類 23195）を URI のリレーを通じて**ユーザー**に送信します。

## イベント

3つのイベントの種類があります：
- `NIP-47 情報イベント`: 13194
- `NIP-47 リクエスト`: 23194
- `NIP-47 レスポンス`: 23195

情報イベントは、**ウォレットサービス**がサポートするコマンドを示すために、リレーに公開される置換可能なイベントである必要があります。コンテンツは、サポートされているコマンドをスペースで区切ったプレーンテキスト文字列である必要があります。例：`pay_invoice get_balance`。この NIP では `pay_invoice` コマンドのみが説明されていますが、他のコマンドは異なる NIP で定義される可能性があります。

リクエストとレスポンスの両方のイベントは、1つの `p` タグを含むべきです（SHOULD）。これには、リクエストの場合は**ウォレットサービス**の公開鍵が、レスポンスの場合は**ユーザー**の公開鍵が含まれます。レスポンスイベントは、応答しているリクエストイベントの id を含む `e` タグを含むべきです（SHOULD）。
オプションで、リクエストには秒単位の Unix タイムスタンプを持つ `expiration` タグを含めることができます。このタイムスタンプ以降にリクエストが受信された場合、無視されるべきです。

リクエストとレスポンスのコンテンツは [NIP04](04.md) で暗号化され、半固定構造の JSON-RPCish オブジェクトです：

リクエスト：
```jsonc
{
    "method": "pay_invoice", // メソッド、文字列
    "params": { // パラメータ、オブジェクト
        "invoice": "lnbc50n1..." // コマンド関連データ
    }
}
```

レスポンス：
```jsonc
{
    "result_type": "pay_invoice", // result フィールドの構造を示す
    "error": { // オブジェクト、エラーの場合は非 null
        "code": "UNAUTHORIZED", // 文字列エラーコード、以下を参照
        "message": "人間が読める形のエラーメッセージ"
    },
    "result": { // 結果、オブジェクト。エラーの場合は null。
        "preimage": "0123456789abcdef..." // コマンド関連データ
    }
}
```

`result_type` フィールドは、このイベントが応答しているメソッドの名前を含まなければなりません（MUST）。
`error` フィールドは、コマンドが成功しなかった場合、人間が読める形のエラーメッセージを含む `message` フィールドとエラーコードを含む `code` フィールドを含まなければなりません（MUST）。
コマンドが成功した場合、`error` フィールドは null でなければなりません。

### エラーコード
- `RATE_LIMITED`: クライアントがコマンドを送信する速度が速すぎます。数秒後に再試行する必要があります。
- `NOT_IMPLEMENTED`: コマンドが不明であるか、意図的に実装されていません。
- `INSUFFICIENT_BALANCE`: ウォレットに手数料の予備または支払い金額をカバーするのに十分な資金がありません。
- `QUOTA_EXCEEDED`: ウォレットが支出クォータを超過しました。
- `RESTRICTED`: この公開鍵はこの操作を行う権限がありません。
- `UNAUTHORIZED`: この公開鍵に接続されているウォレットがありません。
- `INTERNAL`: 内部エラー。
- `OTHER`: その他のエラー。

## Nostr ウォレット接続 URI
**クライアント**は、QR コードをスキャンしたり、ディープリンクを処理したり、URI を貼り付けたりすることで**ウォレットサービス**を発見します。

**ウォレットサービス**は、プロトコル `nostr+walletconnect://` と、16進数エンコードされた `pubkey` をベースパスとして、以下のクエリ文字列パラメータを含む接続 URI を生成します：

- `relay` 必須。**ウォレットサービス**が接続し、イベントをリッスンするリレーの URL。複数可。
- `secret` 必須。32バイトのランダムに生成された16進数エンコードされた文字列。**クライアント**は、**ウォレットサービス**と通信する際にイベントに署名し、ペイロードを暗号化するためにこれを使用しなければなりません（MUST）。
    - 認証には鍵を前後に渡す必要がありません。
    - ユーザーは異なるアプリケーションに対して異なる鍵を持つことができます。鍵は自由に取り消しや作成が可能で、任意の制約（例：予算）を持つことができます。
    - 鍵はユーザーに表示されずバックアップされないため、漏洩しにくくなります。
    - ユーザーのメインの鍵が支払いにリンクされないため、プライバシーが向上します。
- `lud16` 推奨。クライアントが、ユーザーのプロフィールに `lud16` フィールドが設定されていない場合に自動的に設定するために使用できる lightning アドレス。

**クライアント**は、この接続を保存し、ユーザーがインボイスの支払いなどのアクションを実行したい場合に使用する必要があります。この NIP は一時的なイベントを使用するため、非アクティブ時に接続を閉じないリレーを選択することをお勧めします。

### 接続文字列の例
```sh
nostr+walletconnect://b889ff5b1513b641e2a139f661a661364979c5beee91842f8f0ef42ab558e9d4?relay=wss%3A%2F%2Frelay.damus.io&secret=71a8c14c1407c113601079c4302dab36460f0ccd0ad506f1f2dc73b5100e4f3c
```

## コマンド

### `pay_invoice`

説明：インボイスの支払いをリクエストします。

リクエスト：
```jsonc
{
    "method": "pay_invoice",
    "params": {
        "invoice": "lnbc50n1...", // bolt11 インボイス
        "amount": 123, // インボイス金額（ミリサトシ）、オプション
    }
}
```

レスポンス：
```jsonc
{
    "result_type": "pay_invoice",
    "result": {
        "preimage": "0123456789abcdef..." // 支払いのプリイメージ
    }
}
```

エラー：
- `PAYMENT_FAILED`: 支払いが失敗しました。これはタイムアウト、すべてのルートの使い果たし、容量不足などが原因である可能性があります。

### `multi_pay_invoice`

説明：複数のインボイスの支払いをリクエストします。

リクエスト：
```jsonc
{
    "method": "multi_pay_invoice",
    "params": {
        "invoices": [
          {"id":"4da52c32a1", "invoice": "lnbc1...", "amount": 123}, // bolt11 インボイスと金額（ミリサトシ）、金額はオプション
          {"id":"3da52c32a1", "invoice": "lnbc50n1..."},
        ],
    }
}
```

レスポンス：

リクエスト内の各インボイスに対して、別々のレスポンスイベントが送信されます。レスポンスを区別するために、
各レスポンスイベントには、応答しているインボイスの id を含む `d` タグが含まれます。id が指定されていない場合は、
インボイスの支払いハッシュを使用する必要があります。

```jsonc
{
    "result_type": "multi_pay_invoice",
    "result": {
        "preimage": "0123456789abcdef..." // 支払いのプリイメージ
    }
}
```

エラー：
- `PAYMENT_FAILED`: 支払いが失敗しました。これはタイムアウト、すべてのルートの使い果たし、容量不足などが原因である可能性があります。

### `pay_keysend`

リクエスト：
```jsonc
{
    "method": "pay_keysend",
    "params": {
        "amount": 123, // インボイス金額（ミリサトシ）、必須
        "pubkey": "03...", // 受取人の公開鍵、必須
        "preimage": "0123456789abcdef...", // 支払いのプリイメージ、オプション
        "tlv_records: [ // TLV レコード、オプション
            {
                "type": 5482373484, // TLV タイプ
                "value": "0123456789abcdef" // 16進数エンコードされた TLV 値
            }
        ]
    }
}
```

レスポンス：
```jsonc
{
    "result_type": "pay_keysend",
    "result": {
        "preimage": "0123456789abcdef...", // 支払いのプリイメージ
    }
}
```

エラー：
- `PAYMENT_FAILED`: 支払いが失敗しました。これはタイムアウト、すべてのルートの使い果たし、容量不足などが原因である可能性があります。

### `multi_pay_keysend`

説明：複数の keysend 支払いをリクエストします。

keysend の配列があり、これらは `pay_keysend` と同じセマンティクスに従いますが、バッチで実行されます。

リクエスト：
```jsonc
{
    "method": "multi_pay_keysend",
    "params": {
        "keysends": [
          {"id": "4c5b24a351", pubkey": "03...", "amount": 123},
          {"id": "3da52c32a1", "pubkey": "02...", "amount": 567, "preimage": "abc123..", "tlv_records": [{"type": 696969, "value": "77616c5f6872444873305242454d353736"}]},
        ],
    }
}
```

レスポンス：

リクエスト内の各 keysend に対して、別々のレスポンスイベントが送信されます。レスポンスを区別するために、
各レスポンスイベントには、応
答している keysend の id を含む `d` タグが含まれます。id が指定されていない場合は、
公開鍵を使用する必要があります。

```jsonc
{
    "result_type": "multi_pay_keysend",
    "result": {
        "preimage": "0123456789abcdef..." // 支払いのプリイメージ
    }
}
```

エラー：
- `PAYMENT_FAILED`: 支払いが失敗しました。これはタイムアウト、すべてのルートの使い果たし、容量不足などが原因である可能性があります。

### `make_invoice`

リクエスト：
```jsonc
{
    "method": "make_invoice",
    "params": {
        "amount": 123, // ミリサトシ単位の金額
        "description": "string", // インボイスの説明、オプション
        "description_hash": "string", // インボイスの説明ハッシュ、オプション
        "expiry": 213 // インボイス作成時からの有効期限（秒）、オプション
    }
}
```

レスポンス：
```jsonc
{
    "result_type": "make_invoice",
    "result": {
        "type": "incoming", // インボイスの場合は "incoming"、支払いの場合は "outgoing"
        "invoice": "string", // エンコードされたインボイス、オプション
        "description": "string", // インボイスの説明、オプション
        "description_hash": "string", // インボイスの説明ハッシュ、オプション
        "preimage": "string", // 支払いのプリイメージ、未払いの場合はオプション
        "payment_hash": "string", // 支払いのハッシュ
        "amount": 123, // ミリサトシ単位の金額
        "fees_paid": 123, // ミリサトシ単位の支払い手数料
        "created_at": unixtimestamp, // インボイス/支払いの作成時間
        "expires_at": unixtimestamp, // インボイスの有効期限、適用されない場合はオプション
        "metadata": {} // 支払者の名前/コメントなどのzap/boostagramの詳細を追加するために使用できる汎用メタデータ
    }
}
```

### `lookup_invoice`

リクエスト：
```jsonc
{
    "method": "lookup_invoice",
    "params": {
        "payment_hash": "31afdf1..", // インボイスの支払いハッシュ、payment_hash または invoice のいずれかが必要
        "invoice": "lnbc50n1..." // 検索するインボイス
    }
}
```

レスポンス：
```jsonc
{
    "result_type": "lookup_invoice",
    "result": {
        "type": "incoming", // インボイスの場合は "incoming"、支払いの場合は "outgoing"
        "invoice": "string", // エンコードされたインボイス、オプション
        "description": "string", // インボイスの説明、オプション
        "description_hash": "string", // インボイスの説明ハッシュ、オプション
        "preimage": "string", // 支払いのプリイメージ、未払いの場合はオプション
        "payment_hash": "string", // 支払いのハッシュ
        "amount": 123, // ミリサトシ単位の金額
        "fees_paid": 123, // ミリサトシ単位の支払い手数料
        "created_at": unixtimestamp, // インボイス/支払いの作成時間
        "expires_at": unixtimestamp, // インボイスの有効期限、適用されない場合はオプション
        "settled_at": unixtimestamp, // インボイス/支払いの決済時間、未払いの場合はオプション
        "metadata": {} // 支払者の名前/コメントなどのzap/boostagramの詳細を追加するために使用できる汎用メタデータ
    }
}
```

エラー：
- `NOT_FOUND`: 指定されたパラメータでインボイスが見つかりませんでした。

### `list_transactions`

インボイスと支払いをリストします。`type` が指定されていない場合、インボイスと支払いの両方が返されます。
`from` と `until` パラメータはエポックからの秒数でのタイムスタンプです。`from` が指定されていない場合、デフォルトは 0 です。
`until` が指定されていない場合、デフォルトは現在の時刻です。トランザクションは作成時間の降順で返されます。

リクエスト：
```jsonc
{
    "method": "list_transactions",
    "params": {
        "from": 1693876973, // 開始タイムスタンプ（エポックからの秒数、含む）、オプション
        "until": 1703225078, // 終了タイムスタンプ（エポックからの秒数、含む）、オプション
        "limit": 10, // 返すインボイスの最大数、オプション
        "offset": 0, // 返す最初のインボイスのオフセット、オプション
        "unpaid": true, // 未払いのインボイスを含める、オプション、デフォルトは false
        "type": "incoming", // インボイスの場合は "incoming"、支払いの場合は "outgoing"、両方の場合は未定義
    }
}
```

レスポンス：
```jsonc
{
    "result_type": "list_transactions",
    "result": {
        "transactions": [
            {
               "type": "incoming", // インボイスの場合は "incoming"、支払いの場合は "outgoing"
               "invoice": "string", // エンコードされたインボイス、オプション
               "description": "string", // インボイスの説明、オプション
               "description_hash": "string", // インボイスの説明ハッシュ、オプション
               "preimage": "string", // 支払いのプリイメージ、未払いの場合はオプション
               "payment_hash": "string", // 支払いのハッシュ
               "amount": 123, // ミリサトシ単位の金額
               "fees_paid": 123, // ミリサトシ単位の支払い手数料
               "created_at": unixtimestamp, // インボイス/支払いの作成時間
               "expires_at": unixtimestamp, // インボイスの有効期限、適用されない場合はオプション
               "settled_at": unixtimestamp, // インボイス/支払いの決済時間、未払いの場合はオプション
               "metadata": {} // 支払者の名前/コメントなどのzap/boostagramの詳細を追加するために使用できる汎用メタデータ
           }
        ],
    },
}
```

### `get_balance`

リクエスト：
```jsonc
{
    "method": "get_balance",
    "params": {
    }
}
```

レスポンス：
```jsonc
{
    "result_type": "get_balance",
    "result": {
        "balance": 10000, // ユーザーの残高（ミリサトシ）
    }
}
```

### `get_info`

リクエスト：
```jsonc
{
    "method": "get_info",
    "params": {
    }
}
```

レスポンス：
```jsonc
{
    "result_type": "get_info",
    "result": {
            "alias": "string",
            "color": "16進数の文字列",
            "pubkey": "16進数の文字列",
            "network": "string", // mainnet、testnet、signet、または regtest
            "block_height": 1,
            "block_hash": "16進数の文字列",
            "methods": ["pay_invoice", "get_balance", "make_invoice", "lookup_invoice", "list_transactions", "get_info"], // この接続でサポートされているメソッドのリスト
    }
}
```

## インボイス支払いフローの例

0. ユーザーは**ウォレットサービス**が生成した QR コードを**クライアント**アプリケーションでスキャンするか、`nostr+walletconnect://` ディープリンクをフォローするか、接続詳細を手動で設定します。
1. **クライアント**は種類 `23194` のイベントを**ウォレットサービス**に送信します。コンテンツは `pay_invoice` リクエストです。秘密鍵は上記の接続文字列からの秘密です。
2. **ウォレットサービス**は、作成者の鍵が支払いを実行する権限があることを確認し、ペイロードを復号化して支払いを送信します。
3. **ウォレットサービス**は、種類 `23195` のイベントを送信してイベントに応答し、コンテンツはエラーメッセージまたはプリイメージのいずれかを含むレスポンスです。

## 専用リレーの使用
この NIP は使用されるリレーの種類に関する要件を指定していません。ただし、ユーザーがカストディアルサービスを使用している場合、カストディアルサービスがホストするリレーを使用することが理にかなっている場合があります。リレーは、メタデータの漏洩を防ぐために認証を強制する場合があります。この場合、サードパーティのリレーに依存しないことで信頼性も向上します。