---
original: afd45a2d2b593698297f48d4e3b28e79b2fc04ea12814cdc7a6d7f6d67de4cbb
---

NIP-42
======

クライアントからリレーへの認証
-----------------------------------

`draft` `optional`

このNIPは、クライアントが一時的なイベントに署名することでリレーに対して認証を行う方法を定義します。

## 動機

リレーは、制限されたリソースへのアクセスにクライアントの認証を要求する場合があります。例えば、

  - リレーは、イベントを公開するために支払いやその他の形式のホワイトリスト登録を要求する場合があります。これは単純にホワイトリストに登録されたキーで署名されたイベントの公開に制限することで実現できますが、このNIPを使用すれば、認証されたユーザーから公開される限り、どのようなイベントでも受け入れることを選択できます。
  - リレーは、`kind: 4` のDM（ダイレクトメッセージ）へのアクセスをチャット交換に関与する当事者のみに制限し、そのためにクライアントがそのkindをクエリする前に認証を要求する場合があります。
  - リレーは、支払いユーザーやその他の手段でホワイトリストに登録されたユーザーに対してのみ、あらゆる種類のサブスクリプションを制限し、認証を要求する場合があります。

## 定義

### 新しいクライアント-リレープロトコルメッセージ

このNIPは、リレーが認証をサポートしている場合に送信でき、クライアントが認証を行いたい場合にリレーに送信できる新しいメッセージ `AUTH` を定義します。リレーから送信される場合、メッセージは以下の形式になります：

```json
["AUTH", <challenge-string>]
```

そして、クライアントから送信される場合は、以下の形式になります：

```json
["AUTH", <signed-event-json>]
```

クライアントから送信される `AUTH` メッセージは、任意の `EVENT` メッセージと同様に、`OK` メッセージで応答されなければなりません。

### 正規の認証イベント

署名されたイベントは、公開やクエリを目的としない一時的なイベントで、`kind: 22242` でなければならず、少なくともリレーURLとリレーから受け取ったチャレンジ文字列の2つのタグを持つ必要があります。リレーは `kind: 22242` のイベントをクライアントにブロードキャストすることを除外しなければなりません。`created_at` は現在の時刻である必要があります。例：

```json
{
  "kind": 22242,
  "tags": [
    ["relay", "wss://relay.example.com/"],
    ["challenge", "challengestringhere"]
  ],
  ...
}
```

### `OK` と `CLOSED` の機械可読プレフィックス

このNIPは、クライアントからのイベント書き込みに対する応答として `OK` で、クライアントからのサブスクリプションの拒否に対する応答として `CLOSED` で使用できる2つの新しいプレフィックスを定義します：

- `"auth-required: "` - クライアントが `AUTH` を実行しておらず、リレーがクエリを実行するかイベントを書き込むために認証を要求する場合。
- `"restricted: "` - クライアントがすでに `AUTH` を実行しているが、使用されたキーがリレーによってまだ許可されていないか、その認証を超えている場合。

## プロトコルフロー

リレーはいつでもチャレンジを含む `AUTH` メッセージをクライアントに送信することができます。チャレンジは接続の期間中、またはリレーによって別のチャレンジが送信されるまで有効です。クライアントはいつでも `AUTH` イベントを送信することを決定でき、認証されたセッションはその後、接続の期間中有効です。

### `REQ` メッセージに対する `auth-required` の応答

リレーは、`REQ` に応答したり `EVENT` の書き込みを受け入れたりするような特定のジョブに対してのみクライアントに認証を要求する可能性が高いため、以下は予想される一般的なフローの例です：

```
relay: ["AUTH", "<challenge>"]
client: ["REQ", "sub_1", {"kinds": [4]}]
relay: ["CLOSED", "sub_1", "auth-required: we can't serve DMs to unauthenticated users"]
client: ["AUTH", {"id": "abcdef...", ...}]
relay: ["OK", "abcdef...", true, ""]
client: ["REQ", "sub_1", {"kinds": [4]}]
relay: ["EVENT", "sub_1", {...}]
relay: ["EVENT", "sub_1", {...}]
relay: ["EVENT", "sub_1", {...}]
relay: ["EVENT", "sub_1", {...}]
...
```

この場合、リレーからの `AUTH` メッセージは、クライアントが接続した直後に送信されるか、`CLOSED` が送信される直前に送信される可能性があります。唯一の要件は、_クライアントがそのリレーに関連付けられた保存されたチャレンジを持っている_ことで、`auth-required` の `CLOSED` メッセージに応じて行動できることです。

### `EVENT` メッセージに対する `auth-required` の応答

クライアントがリレーに `EVENT` を書き込みたい場合も同じフローが有効ですが、この場合、リレーは `CLOSED` メッセージの代わりに `OK` メッセージを送り返します：

```
relay: ["AUTH", "<challenge>"]
client: ["EVENT", {"id": "012345...", ...}]
relay: ["OK", "012345...", false, "auth-required: we only accept events from registered users"]
client: ["AUTH", {"id": "abcdef...", ...}]
relay: ["OK", "abcdef...", true, ""]
client: ["EVENT", {"id": "012345...", ...}]
relay: ["OK", "012345...", true, ""]
```

## 署名されたイベントの検証

`AUTH` メッセージを検証するために、リレーは以下を確認する必要があります：

  - `kind` が `22242` であること。
  - イベントの `created_at` が現在時刻に近い（例：10分以内）こと。
  - `"challenge"` タグが以前に送信されたチャレンジと一致すること。
  - `"relay"` タグがリレーのURLと一致すること：
    - URL正規化技術を適用できます。ほとんどの場合、ドメイン名が正しいかどうかを確認するだけで十分です。